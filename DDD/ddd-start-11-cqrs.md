# [DDD START!] 11장 CQRS

## 단일 모델의 단점

- 조회 기능 구현 시 여러 애그리거트에서 데이터를 가져온다.
- 여러 애그리거트에서 데이터를 가져올 경우
  - ID로 다른 애그리거트를 참조하는 방식 사용 시
    - 한 번의 Select 쿼리로 필요한 데이터를 모두 가져울 수 없어 속도가 느리다.
  - 직접 참조로 애그리거트가 연관되어 있어도
    - 조회 요구 사항에 따라 즉시 로딩이나 지연 로딩이 필요한 경우 쿼리문을 직접 작성해야 할 수 있다.
- 시스템의 상태 변경과 조회를 모두 단일 도메인 모델만 사용해서 이런 문제가 발생한다.
  - ORM은 도메인의 상태 변경 구현에 적합하지만, 데이터 조회 기능 구현을 복잡하게 하는 원인이 된다.
- 상태 변경용 모델과 조회 전용 모델을 분리하면 구현 복잡도가 낮아진다.

## CQRS

- 시스템은 보통 상태 변경과 조회 기능을 제공한다.
- 상태 변경 기능은 한 애그리거트에서 일어난다.
- 조회 기능은 여러 애그리거트를 사용하는 경우가 있다.
- 상태 변경 범위와 조회 범위가 일치하지 않아서 단일 모델로 기능 구현 시도 시 모델이 지나치게 복잡해진다.

### CQRS란

- Command Query Responsibility Segregation의 약자이다.
- 상태 변경하는 명령(Command)을 위한 모델과 상태를 제공하는 조회(Query)를 위한 모델을 분리하는 패턴이다.
- 조회를 위한 모델을 따로 만들어서 도메인 모델이 복잡해지는 것을 막는다.

### CQRS 구현

- 각 모델에 맞는 구현 기술 선택이 가능하다.
- 명령 모델은 JPA로 객체 지향 기반 도메인 모델을 구현하고
- 조회 모델은 MyBaits로 DB 테이블에서 SQL로 데이터를 조회할 수 있다.

![CQRS_Exmaple](https://user-images.githubusercontent.com/22253556/132344839-b88ae447-7565-486c-925c-34f508f5cae7.png)

- 조회 모델은 응용 로직이 복잡하지 않아서 응용 서비스 레이어를 따로 두지 않아도 된다.

### 명령과 조회 모델 간 DB 분리하기

- 명령 모델과 조회 모델이 다른 DB를 사용할 수 있다.
  - 명령 모델은 트랜잭션을 지원하는 RDBMS를 사용하고
  - 조회 모델은 조회 성능이 좋은 메모리 기반 NoSQL을 사용할 수 있다.
- 두 데이터 저장소 간 데이터 동기화는 이벤트를 활용한다.

### 웹에 적합한 CQRS

- 일반적인 웹 서비스는 상태 변경 요청보다 상태 조회 요청이 많다.
  - ex) 쇼핑몰은 주문 요청보다 상품 상세정보 조회 요청이 훨씬 많다.
- 개발팀은 조회 성능을 높이기 위해 다양한 기법을 적용한다.
  - 쿼리 최적화
  - 메모리에 조회 데이터를 캐시
  - 조회 전용 저장소 따로 사용
- 이런 기법은 사용하는 것은 CQRS를 적용하는 것과 효과가 같다.

### CQRS 장점

- 명령 모델을 구현할 때 도메인 자체에 집중할 수 있다.
  - 복잡한 모델에 조회 관련 로직이 없어서 복잡도가 낮아진다.
- 조회 성능을 향상시키기 유리하다.
  - 캐시 도입이나 쿼리 최적화 같은 기법을 적용할 수 있다.
  - 조회 성능을 높이기 위한 코드가 명령 모델에 영향을 주지 않는다.

### CQRS 단점

- 구현할 코드가 많아진다.
  - 도메인이 단순하고 트래픽이 많지 않다면 적용할 이유가 없다.
  - 도메인이 복잡하지 않은데 CQRS를 도입하면, 두 모델을 유지하는 비용만 높아진다.
- 더 많은 구현 기술이 필요하다.
  - 명령 모델과 조회 모델의 구현 기술이나 저장소가 다를 수 있다.
  - 데이터 동기화를 위해 메시징 시스템을 도입해야 할 수도 있다.
